@using Radzen
@using Radzen.Blazor
@using KlantBaseWASM.Models
@using KlantBaseShare.Dtos
@using KlantBaseWASM.Services
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@using Newtonsoft.Json
@inject IHttpClientFactory HttpClientFactory
@inject HttpClient HttpClient
@inject DialogService DialogService
@inject DetailsService DetailsService

<RadzenStack Orientation="Orientation.Horizontal" Gap="10px">
    <RadzenText>
        Actie @Action.FldMid: gemaakt @(Action.FldMDatum?.ToString("dd-MM-yyyy") ?? "N/A"): door @(Werknemers.FirstOrDefault(w => w.WerknId == Action.WerknId)?.Voornaam ?? "Onbekend")
    </RadzenText>
</RadzenStack>
<RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
    <RadzenFormField Text="Klant">
        <RadzenAutoComplete @bind-Value="searchKlantTerm"
                            LoadData="@LoadKlantData"
                            TextProperty="Zoekcode"
                            Data="@klanten"
                            Style="width: 100%;"
                            Placeholder="Zoek klant (zoekcode, naam, plaats)..."
                            OpenOnFocus="true"
                            MinLength="1">
            <Template Context="klant">
                @klant.Zoekcode - @klant.Naam (@klant.Plaats)
            </Template>
        </RadzenAutoComplete>
    </RadzenFormField>
    <RadzenText Text="@KlantDetails" />
</RadzenStack>

<RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
    <RadzenFormField Text="Contactpersoon">
        <RadzenAutoComplete @bind-Value="searchContactpersoonTerm"
                            LoadData="@LoadContactpersoonData"
                            TextProperty="Achternaam"
                            Data="@Contactpersoonen"
                            Style="width: 100%;"
                            Placeholder="Zoek Contactpersoon (nummer, omschrijving)..."
                            OpenOnFocus="true"
                            MinLength="1">
            <Template Context="Contactpersoon">
                @Contactpersoon.VolledigeNaam
            </Template>
        </RadzenAutoComplete>
    </RadzenFormField>
    <RadzenText Text="@ContactpersoonDetails" />
</RadzenStack>

<RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
    <RadzenFormField Text="Project">
        <RadzenAutoComplete @bind-Value="searchProjectTerm"
                            LoadData="@LoadProjectData"
                            TextProperty="ProjectNummer"
                            Data="@projecten"
                            Style="width: 100%;"
                            Placeholder="Zoek project (nummer, omschrijving)..."
                            OpenOnFocus="true"
                            MinLength="1">
            <Template Context="project">
                @project.ProjectNummer - @project.Omschrijving
            </Template>
        </RadzenAutoComplete>
    </RadzenFormField>
    <RadzenText Text="@ProjectDetails" />
</RadzenStack>

<RadzenStack Orientation="Orientation.Horizontal" Gap="10px" AlignItems="AlignItems.Center">
    <RadzenFormField Text="Opdracht">
        <RadzenAutoComplete @bind-Value="searchOpdrachtTerm"
                            LoadData="@LoadOpdrachtData"
                            TextProperty="OpdrachtNummer"
                            Data="@Opdrachten"
                            Style="width: 100%;"
                            Placeholder="Zoek Opdracht (nummer, omschrijving)..."
                            OpenOnFocus="true"
                            MinLength="1">
            <Template Context="Opdracht">
                @Opdracht.OpdrachtNummer
            </Template>
        </RadzenAutoComplete>
    </RadzenFormField>
    <RadzenText Text="@OpdrachtDetails" />
</RadzenStack>
<RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center">
    <RadzenFormField Text="Voor">
        <RadzenDropDown Data="@Werknemers" TextProperty="Voornaam" ValueProperty="WerknId" @bind-Value="Action.FldMActieVoor" Style="width:100%" AllowClear="true" />
    </RadzenFormField>
    <RadzenFormField Text="en/of">
        <RadzenDropDown Data="@Werknemers" TextProperty="Voornaam" ValueProperty="WerknId" @bind-Value="Action.FldMActieVoor2" Style="width:100%" AllowClear="true" />
    </RadzenFormField>
</RadzenStack>
<RadzenRow>
    <RadzenFormField Text="Omschrijving">
        <RadzenTextArea @bind-Value="Action.FldOmschrijving" Style="width:100%" cols="80" Rows="4" />
    </RadzenFormField>
</RadzenRow>
<RadzenRow>
    <RadzenFormField Text="Soort actie">
        <RadzenDropDown Data="@actionTypes" TextProperty="Omschrijving" ValueProperty="Id" @bind-Value="Action.FldMActieSoort" Style="width:100%" AllowClear="true" />
    </RadzenFormField>
</RadzenRow>
<RadzenFormField Text="Uitvoeren voor:">
    <RadzenDatePicker @bind-Value="Action.FldMActieDatum" DateFormat="dd-MM-yyyy" Style="width:70%" />
</RadzenFormField>
<RadzenRow>
    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.End">
        <RadzenText>Actie gereed:</RadzenText>
        <RadzenFormField>
            <RadzenCheckBox @bind-Value="IsCompleted" />
        </RadzenFormField>
        <RadzenText>
            @(Action.FldMActieGereed?.ToString("ddd dd-MM-yyyy") ?? "N/A")
        </RadzenText>
    </RadzenStack>
</RadzenRow>
<RadzenFormField Text="Priority">
    <RadzenNumeric @bind-Value="Action.FldMPrioriteit" Style="width:100%" AllowClear="true" />
</RadzenFormField>
<div class="mt-3">
    <RadzenButton Text="Save" Click="@SaveAction" />
    <RadzenButton Text="Cancel" Click="@(() => DialogService.Close())" />
</div>

@code {
    [Parameter] public Actie Action { get; set; } = new();
    private List<ActieSoort> actionTypes = new();
    [Parameter] public List<Werknemer> Werknemers { get; set; }
    [Parameter] public Dictionary<int, string> ActieSoortLookup { get; set; }
    [Parameter] public List<Priority> Priorities { get; set; }

    private string KlantDetails { get; set; }
    private List<KlantDTO> klanten { get; set; } = new List<KlantDTO>();  // Lokale lijst voor suggesties (initieel leeg)
    private KlantDTO KlantCurrent = new KlantDTO();  // Huidige klant details
    private string searchKlantTerm { get; set; } = string.Empty;  // Bestaande variabele

    private async Task LoadKlantData(LoadDataArgs args)
    {
        var term = args.Filter ?? searchKlantTerm;
        Console.WriteLine($"Zoeken naar klanten met term: {term}");  // Log voor debug
        var results = await DetailsService.SearchKlantAsync(term);
        Console.WriteLine($"Resultaten gevonden: {results.Count}");  // Log aantal resultaten
        klanten = results;  // Update lijst
    }

    private async Task OnKlantChanged(string value)
    {
        searchKlantTerm = value;
        if (int.TryParse(value, out int klantId))
        {
            Action.FldMKlantId = klantId;
            KlantDetails = "Laden..."; // Tijdelijke placeholder
            KlantCurrent = await DetailsService.GetKlantDetailsAsync(klantId); // Async call
        }
        else
        {
            Action.FldMKlantId = null;
            KlantDetails = "Onbekend";
        }
    }

    private List<ProjectDTO> projecten { get; set; } = new List<ProjectDTO>();  // Lokale lijst voor suggesties (initieel leeg)
    private ProjectDTO ProjectCurrent = new ProjectDTO();  // Huidige klant details
    private string searchProjectTerm { get; set; } = string.Empty;  // Bestaande variabele
    private string ProjectDetails { get; set; }

    private async Task LoadProjectData(LoadDataArgs args)
    {
        var term = args.Filter ?? searchProjectTerm;
        Console.WriteLine($"Zoeken naar projecten met term: {term}");  // Log voor debug
        var results = await DetailsService.SearchProjectAsync(term);
        Console.WriteLine($"Resultaten gevonden: {results.Count}");  // Log aantal resultaten
        projecten = results;  // Update lijst
    }

    private async Task OnProjectChanged(string value)
    {
        searchProjectTerm = value;
        if (int.TryParse(value, out int ProjectId))
        {
            Action.FldMProjectId = ProjectId;
            ProjectDetails = "Laden..."; // Tijdelijke placeholder
            ProjectCurrent = await DetailsService.GetProjectDetailsAsync(ProjectId); // Async call
        }
        else
        {
            Action.FldMKlantId = null;
            ProjectDetails = "Onbekend";
        }
    }

    private List<ContactpersoonDTO> Contactpersoonen { get; set; } = new List<ContactpersoonDTO>();  // Lokale lijst voor suggesties (initieel leeg)
    private ContactpersoonDTO ContactpersoonCurrent = new ContactpersoonDTO();  // Huidige klant details
    private string searchContactpersoonTerm { get; set; } = string.Empty;  // Bestaande variabele
    private string ContactpersoonDetails { get; set; }

    private async Task LoadContactpersoonData(LoadDataArgs args)
    {
        var term = args.Filter ?? searchContactpersoonTerm;
        Console.WriteLine($"Zoeken naar Contactpersoonen met term: {term}");  // Log voor debug
        var results = await DetailsService.SearchContactpersoonAsync(term);
        Console.WriteLine($"Resultaten gevonden: {results.Count}");  // Log aantal resultaten
        Contactpersoonen = results;  // Update lijst
    }

    private async Task OnContactpersoonChanged(string value)
    {
        searchContactpersoonTerm = value;
        /*
        if (string.TryParse(value, out int ContactpersoonId))
        {
            Action.FldMContactPers = ContactpersoonId;
            ContactpersoonDetails = "Laden..."; // Tijdelijke placeholder
            ContactpersoonCurrent = await DetailsService.GetContactpersoonDetailsAsync(ContactpersoonId); // Async call
        }
        else
        {
            Action.FldMKlantId = null;
            ContactpersoonDetails = "Onbekend";
        }*/
    }

    private List<OpdrachtDTO> Opdrachten { get; set; } = new List<OpdrachtDTO>();  // Lokale lijst voor suggesties (initieel leeg)
    private OpdrachtDTO OpdrachtCurrent = new OpdrachtDTO();  // Huidige klant details
    private string searchOpdrachtTerm { get; set; } = string.Empty;  // Bestaande variabele
    private string OpdrachtDetails { get; set; }

    private async Task LoadOpdrachtData(LoadDataArgs args)
    {
        var term = args.Filter ?? searchOpdrachtTerm;
        Console.WriteLine($"Zoeken naar Opdrachten met term: {term}");  // Log voor debug
        var results = await DetailsService.SearchOpdrachtAsync(term);
        Console.WriteLine($"Resultaten gevonden: {results.Count}");  // Log aantal resultaten
        Opdrachten = results;  // Update lijst
    }

    private async Task OnOpdrachtChanged(string value)
    {
        searchOpdrachtTerm = value;
        if (int.TryParse(value, out int OpdrachtId))
        {
            Action.FldOpdrachtId = OpdrachtId;
            OpdrachtDetails = "Laden..."; // Tijdelijke placeholder
            OpdrachtCurrent = await DetailsService.GetOpdrachtDetailsAsync(OpdrachtId); // Async call
        }
        else
        {
            Action.FldMKlantId = null;
            OpdrachtDetails = "Onbekend";
        }
    }

    private bool? IsCompleted
    {
        get => Action.FldMActieGereed.HasValue;
        set
        {
            if (value == true && !Action.FldMActieGereed.HasValue)
            {
                Action.FldMActieGereed = DateTime.Now;
            }
            else if (value == false && Action.FldMActieGereed.HasValue)
            {
                Action.FldMActieGereed = null;
            }
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (ActieSoortLookup != null)
            {
                actionTypes = ActieSoortLookup.Select(kvp => new ActieSoort { Id = kvp.Key, Omschrijving = kvp.Value }).ToList();
            }
            if (Action.FldMKlantId.HasValue)
            {
                var KlantCurrent = await DetailsService.GetKlantDetailsAsync(Action.FldMKlantId);   // Nieuwe methode nodig
                searchKlantTerm = KlantCurrent?.Zoekcode ?? string.Empty;  // Stel huidige Zoekcode in
                KlantDetails = $"{KlantCurrent?.Naam} ({KlantCurrent?.Plaats})";  // Toon details

                var ProjectCurrent = await DetailsService.GetProjectDetailsAsync(Action.FldMProjectId);   // Nieuwe methode nodig
                searchProjectTerm = ProjectCurrent?.ProjectNummer ?? string.Empty;  // Stel huidige Zoekcode in
                ProjectDetails = $"{ProjectCurrent?.ProjectNummer} ({ProjectCurrent?.Omschrijving})";  // Toon details

                var ContactpersoonCurrent = await DetailsService.GetContactpersoonDetailsAsync(Action.FldMContactPers);   // Nieuwe methode nodig
                searchContactpersoonTerm = ContactpersoonCurrent?.Achternaam ?? string.Empty;  // Stel huidige Zoekcode in
                ContactpersoonDetails = $"{ContactpersoonCurrent?.VolledigeNaam}";  // Toon details

                var OpdrachtCurrent = await DetailsService.GetOpdrachtDetailsAsync(Action.FldOpdrachtId);   // Nieuwe methode nodig
                searchOpdrachtTerm = OpdrachtCurrent?.OpdrachtNummer ?? string.Empty;  // Stel huidige Zoekcode in
                OpdrachtDetails = $"{OpdrachtCurrent?.Omschrijving}";  // Toon details
            }
            Console.WriteLine($"Huidige klant ingesteld: {searchKlantTerm}");
            Console.WriteLine($"Huidig project ingesteld: {searchProjectTerm}");
            Console.WriteLine($"Huidige contactpersoon ingesteld: {searchContactpersoonTerm}");
            Console.WriteLine($"Huidigw opdracht ingesteld: {searchOpdrachtTerm}");

        }
        catch (Exception ex)
        {
            DialogService.Alert("Error loading data: " + ex.Message);
        }
    }

    private async Task SaveAction()
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("ActielijstAPI");
            var actionToSave = new Actie
            {
                FldMid = Action.FldMid,
                FldMDatum = Action.FldMDatum,
                WerknId = Action.WerknId,
                FldMKlantId = Action.FldMKlantId,
                FldMContactPers = Action.FldMContactPers,
                FldMProjectId = Action.FldMProjectId,
                FldOpdrachtId = Action.FldOpdrachtId,
                FldOmschrijving = Action.FldOmschrijving,
                FldMAfspraak = Action.FldMAfspraak,
                FldMActieDatum = Action.FldMActieDatum,
                FldMActieVoor = Action.FldMActieVoor,
                FldMActieVoor2 = Action.FldMActieVoor2,
                FldMActieGereed = Action.FldMActieGereed,
                FldMActieSoort = Action.FldMActieSoort,
                FldMPrioriteit = Action.FldMPrioriteit
            };
            var response = await httpClient.PutAsJsonAsync($"api/acties/{Action.FldMid}", actionToSave);
            response.EnsureSuccessStatusCode();
            DialogService.Close(true);
        }
        catch (Exception ex)
        {
            DialogService.Alert("Error saving action: " + ex.Message);
        }
    }

}